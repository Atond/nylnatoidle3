<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Fix Equipment Stats</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }
        .test-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        h1 {
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .subtitle {
            text-align: center;
            opacity: 0.9;
            margin-bottom: 30px;
        }
        .test-section {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .test-section h2 {
            margin-top: 0;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 10px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        button:active {
            transform: translateY(0);
        }
        .result {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            color: #4ade80;
            font-weight: bold;
        }
        .error {
            color: #f87171;
            font-weight: bold;
        }
        .warning {
            color: #fbbf24;
            font-weight: bold;
        }
        .info {
            color: #60a5fa;
            font-weight: bold;
        }
        .stat-line {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üõ°Ô∏è Test - Correction Stats d'√âquipement</h1>
        <p class="subtitle">V√©rification des corrections de multiplication des stats</p>

        <div class="test-section">
            <h2>üìù Test 1 : Cr√©ation d'√âquipement</h2>
            <p>Teste la cr√©ation d'un √©quipement avec qualit√© et v√©rifie les stats</p>
            <button onclick="testEquipmentCreation()">Lancer le test</button>
            <div id="result1" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>üîÑ Test 2 : Serialisation/D√©s√©rialisation</h2>
            <p>Simule un save/load et v√©rifie que les stats ne sont pas remultipli√©es</p>
            <button onclick="testSaveLoad()">Lancer le test</button>
            <div id="result2" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>‚ôªÔ∏è Test 3 : Multiple Save/Load</h2>
            <p>Simule 5 cycles de save/load pour v√©rifier la stabilit√©</p>
            <button onclick="testMultipleSaveLoad()">Lancer le test</button>
            <div id="result3" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>üíæ Test 4 : Votre Sauvegarde</h2>
            <p>Teste avec les donn√©es de votre sauvegarde export√©e</p>
            <button onclick="testYourSave()">Lancer le test</button>
            <div id="result4" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>üéÆ Test 5 : Character Creation Modal</h2>
            <p>V√©rifie que le modal ne s'affiche pas avec une sauvegarde valide</p>
            <button onclick="testCharacterModal()">Lancer le test</button>
            <div id="result5" class="result" style="display:none;"></div>
        </div>
    </div>

    <script src="src/js/equipment.js"></script>
    <script>
        function log(elementId, message, type = 'info') {
            const result = document.getElementById(elementId);
            result.style.display = 'block';
            const span = document.createElement('span');
            span.className = type;
            span.textContent = message + '\n';
            result.appendChild(span);
        }

        function clear(elementId) {
            const result = document.getElementById(elementId);
            result.innerHTML = '';
            result.style.display = 'none';
        }

        function testEquipmentCreation() {
            clear('result1');
            log('result1', '=== TEST 1 : CR√âATION D\'√âQUIPEMENT ===\n', 'info');

            try {
                // Cr√©er un √©quipement avec qualit√© perfect (x2)
                const sword = new Equipment({
                    id: 'test_sword',
                    name: '√âp√©e de Test',
                    type: 'weapon',
                    slot: 'weapon',
                    rarity: 'common',
                    quality: 'perfect',
                    icon: '‚öîÔ∏è',
                    stats: {
                        force: 10,
                        damage: 15
                    },
                    requiredLevel: 1,
                    description: 'Une √©p√©e de test'
                });

                log('result1', '‚úì √âquipement cr√©√©', 'success');
                log('result1', `  Qualit√©: ${sword.quality} (x${sword.qualityMultiplier})`, 'info');
                log('result1', `  Stats de base: Force 10, Damage 15`, 'info');
                log('result1', `  Stats calcul√©es: Force ${sword.stats.force}, Damage ${sword.stats.damage}`, 'info');

                // V√©rifier que les stats sont bien multipli√©es
                const expectedForce = 10 * 2;
                const expectedDamage = 15 * 2;

                if (sword.stats.force === expectedForce && sword.stats.damage === expectedDamage) {
                    log('result1', '\n‚úÖ TEST R√âUSSI : Stats correctement multipli√©es', 'success');
                } else {
                    log('result1', `\n‚ùå TEST √âCHOU√â : Stats incorrectes`, 'error');
                    log('result1', `   Attendu: Force ${expectedForce}, Damage ${expectedDamage}`, 'error');
                    log('result1', `   Obtenu: Force ${sword.stats.force}, Damage ${sword.stats.damage}`, 'error');
                }

            } catch (error) {
                log('result1', `\n‚ùå ERREUR : ${error.message}`, 'error');
            }
        }

        function testSaveLoad() {
            clear('result2');
            log('result2', '=== TEST 2 : SAVE/LOAD ===\n', 'info');

            try {
                // Cr√©er un √©quipement
                const sword = new Equipment({
                    id: 'test_sword',
                    name: '√âp√©e de Test',
                    type: 'weapon',
                    slot: 'weapon',
                    rarity: 'rare',
                    quality: 'exceptional',
                    icon: '‚öîÔ∏è',
                    stats: {
                        force: 20,
                        damage: 30
                    },
                    requiredLevel: 5,
                    description: 'Une √©p√©e de test'
                });

                log('result2', '‚úì √âquipement original cr√©√©', 'success');
                log('result2', `  Qualit√©: ${sword.quality} (x${sword.qualityMultiplier})`, 'info');
                log('result2', `  Stats: Force ${sword.stats.force}, Damage ${sword.stats.damage}`, 'info');

                // S√©rialiser (save)
                const savedData = sword.toJSON();
                log('result2', '\n‚úì Sauvegarde effectu√©e', 'success');

                // D√©s√©rialiser (load)
                const loadedSword = Equipment.fromJSON(savedData);
                log('result2', '\n‚úì Chargement effectu√©', 'success');
                log('result2', `  Stats: Force ${loadedSword.stats.force}, Damage ${loadedSword.stats.damage}`, 'info');

                // V√©rifier que les stats n'ont PAS √©t√© remultipli√©es
                if (loadedSword.stats.force === sword.stats.force && 
                    loadedSword.stats.damage === sword.stats.damage) {
                    log('result2', '\n‚úÖ TEST R√âUSSI : Stats identiques apr√®s load', 'success');
                } else {
                    log('result2', '\n‚ùå TEST √âCHOU√â : Stats modifi√©es apr√®s load', 'error');
                    log('result2', `   Original: Force ${sword.stats.force}, Damage ${sword.stats.damage}`, 'error');
                    log('result2', `   Charg√©: Force ${loadedSword.stats.force}, Damage ${loadedSword.stats.damage}`, 'error');
                }

            } catch (error) {
                log('result2', `\n‚ùå ERREUR : ${error.message}`, 'error');
            }
        }

        function testMultipleSaveLoad() {
            clear('result3');
            log('result3', '=== TEST 3 : MULTIPLE SAVE/LOAD (5x) ===\n', 'info');

            try {
                // Cr√©er un √©quipement
                let equipment = new Equipment({
                    id: 'test_equipment',
                    name: '√âquipement de Test',
                    type: 'armor',
                    slot: 'chest',
                    rarity: 'epic',
                    quality: 'perfect',
                    icon: 'üëî',
                    stats: {
                        defense: 50,
                        endurance: 25
                    },
                    requiredLevel: 10,
                    description: 'Un √©quipement de test'
                });

                const originalDefense = equipment.stats.defense;
                const originalEndurance = equipment.stats.endurance;

                log('result3', `‚úì √âquipement cr√©√©`, 'success');
                log('result3', `  Stats originales: Defense ${originalDefense}, Endurance ${originalEndurance}\n`, 'info');

                let allTestsPassed = true;

                // Simuler 5 cycles de save/load
                for (let i = 1; i <= 5; i++) {
                    const savedData = equipment.toJSON();
                    equipment = Equipment.fromJSON(savedData);

                    log('result3', `Cycle ${i}:`, 'info');
                    log('result3', `  Defense: ${equipment.stats.defense} (${equipment.stats.defense === originalDefense ? '‚úì' : '‚úó'})`, 
                        equipment.stats.defense === originalDefense ? 'success' : 'error');
                    log('result3', `  Endurance: ${equipment.stats.endurance} (${equipment.stats.endurance === originalEndurance ? '‚úì' : '‚úó'})`, 
                        equipment.stats.endurance === originalEndurance ? 'success' : 'error');

                    if (equipment.stats.defense !== originalDefense || equipment.stats.endurance !== originalEndurance) {
                        allTestsPassed = false;
                    }
                }

                if (allTestsPassed) {
                    log('result3', '\n‚úÖ TEST R√âUSSI : Stats stables apr√®s 5 cycles', 'success');
                } else {
                    log('result3', '\n‚ùå TEST √âCHOU√â : Stats modifi√©es pendant les cycles', 'error');
                }

            } catch (error) {
                log('result3', `\n‚ùå ERREUR : ${error.message}`, 'error');
            }
        }

        function testYourSave() {
            clear('result4');
            log('result4', '=== TEST 4 : VOTRE SAUVEGARDE ===\n', 'info');

            try {
                // Simuler votre √©p√©e avec des stats d√©j√† hautes
                const yourSwordData = {
                    id: 'iron_sword_1760301654506',
                    name: '√âp√©e de Fer',
                    type: 'weapon',
                    slot: 'weapon',
                    rarity: 'common',
                    quality: 'perfect',
                    qualityMultiplier: 2,
                    locked: false,
                    icon: '‚öîÔ∏è',
                    stats: {
                        force: 20480,
                        damage: 32768,
                        agility: 0,
                        intelligence: 0,
                        wisdom: 0,
                        endurance: 0,
                        defense: 0,
                        professionXP: 0,
                        dropRate: 0
                    },
                    requiredLevel: 1,
                    description: 'Une simple √©p√©e en fer forg√©.'
                };

                log('result4', '‚úì Donn√©es de votre sauvegarde charg√©es', 'success');
                log('result4', `  Stats sauvegard√©es: Force ${yourSwordData.stats.force}, Damage ${yourSwordData.stats.damage}`, 'warning');

                // Charger l'√©quipement
                const loadedSword = Equipment.fromJSON(yourSwordData);

                log('result4', '\n‚úì √âquipement charg√©', 'success');
                log('result4', `  Stats charg√©es: Force ${loadedSword.stats.force}, Damage ${loadedSword.stats.damage}`, 'info');

                // V√©rifier que les stats n'ont PAS chang√©
                if (loadedSword.stats.force === yourSwordData.stats.force &&
                    loadedSword.stats.damage === yourSwordData.stats.damage) {
                    log('result4', '\n‚úÖ TEST R√âUSSI : Stats restent hautes mais stables', 'success');
                    log('result4', '   Les stats ne seront plus multipli√©es √† chaque refresh', 'success');
                    log('result4', '\nüí° CONSEIL : Pour retrouver des stats normales:', 'info');
                    log('result4', '   1. Vendez l\'√©quipement bugg√©', 'info');
                    log('result4', '   2. Re-craftez un nouvel √©quipement', 'info');
                    log('result4', '   3. Les nouveaux objets auront des stats normales', 'info');
                } else {
                    log('result4', '\n‚ùå TEST √âCHOU√â : Stats modifi√©es (bug toujours pr√©sent)', 'error');
                }

            } catch (error) {
                log('result4', `\n‚ùå ERREUR : ${error.message}`, 'error');
            }
        }

        function testCharacterModal() {
            clear('result5');
            log('result5', '=== TEST 5 : CHARACTER CREATION MODAL ===\n', 'info');

            try {
                // Simuler un player avec sauvegarde valide
                const mockGame = {
                    player: {
                        name: 'Ato',
                        gender: 'male',
                        class: 'warrior',
                        isMainCharacter: true
                    }
                };

                log('result5', '‚úì Joueur simul√© cr√©√©', 'success');
                log('result5', `  Nom: ${mockGame.player.name}`, 'info');
                log('result5', `  Classe: ${mockGame.player.class}`, 'info');
                log('result5', `  isMainCharacter: ${mockGame.player.isMainCharacter}`, 'info');

                // Simuler la logique de shouldShow()
                const hasClass = mockGame.player.class !== null;
                const shouldShow = !hasClass;

                log('result5', `\n‚úì V√©rification effectu√©e`, 'success');
                log('result5', `  hasClass: ${hasClass}`, 'info');
                log('result5', `  shouldShow: ${shouldShow}`, shouldShow ? 'error' : 'success');

                if (!shouldShow) {
                    log('result5', '\n‚úÖ TEST R√âUSSI : Modal ne s\'affichera pas', 'success');
                } else {
                    log('result5', '\n‚ùå TEST √âCHOU√â : Modal s\'affichera (bug)', 'error');
                }

                // Test avec un nouveau joueur
                const newPlayerGame = {
                    player: {
                        name: 'Aventurier',
                        gender: null,
                        class: null,
                        isMainCharacter: true
                    }
                };

                const hasClassNew = newPlayerGame.player.class !== null;
                const shouldShowNew = !hasClassNew;

                log('result5', '\n--- Test avec nouveau joueur ---', 'info');
                log('result5', `  hasClass: ${hasClassNew}`, 'info');
                log('result5', `  shouldShow: ${shouldShowNew}`, shouldShowNew ? 'success' : 'error');

                if (shouldShowNew) {
                    log('result5', '‚úÖ Nouveau joueur : Modal s\'affichera (correct)', 'success');
                } else {
                    log('result5', '‚ùå Nouveau joueur : Modal ne s\'affichera pas (erreur)', 'error');
                }

            } catch (error) {
                log('result5', `\n‚ùå ERREUR : ${error.message}`, 'error');
            }
        }

        // Afficher un message de bienvenue
        setTimeout(() => {
            console.log('%cüõ°Ô∏è Tests de Correction - Equipment Stats', 'font-size: 20px; font-weight: bold; color: #667eea;');
            console.log('%cCliquez sur les boutons pour lancer les tests', 'font-size: 14px; color: #888;');
        }, 100);
    </script>
</body>
</html>
